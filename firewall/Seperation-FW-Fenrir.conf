# David Koch? - 5CN HTL3R
# Diplomarbeit Fenrir
# Seperation-Firewall

# execute factoryreset

# Weil der Factory Reset nervige Konfigurationen mit sich bringt...
config firewall policy
    delete 1
end

config system dhcp server
    delete 1
end

config system virtual-switch
    delete internal
end

config system global
    set switch-controller disable
end

config system interface
    edit wan1
        set mode static
    next
    edit wan2
        set mode static
    next
end

# Ab hier geht der echte Spaß los

config system global
    set admintimeout 30
    set hostname "Seperation-FW-Fenrir"
    set timezone 26
end
y

config sys interface
    edit wan1
        set description "To Uplink Firewall"
        set vdom "root"
        set ip 172.16.10.1 255.255.255.252
        set allowaccess ping
        set type physical
        set snmp-index 1
    next
    edit wan2
        set description "To Cell Firewall"
        set vdom "root"
        set ip 172.16.10.6 255.255.255.252
        set allowaccess ping
        set type physical
        set snmp-index 2
    next
    edit "VLAN_10"
        set description "VLAN for Cell 1 Traffic"
        set vdom "root"
        set mode static
        set ip 172.16.11.6 255.255.255.252
        set type vlan
        set interface wan2
        set vlanid 10
        set allowaccess ping
    next
    edit "VLAN_20"
        set description "VLAN for Cell 2 Traffic"
        set vdom "root"
        set mode static
        set ip 172.16.12.6 255.255.255.252
        set type vlan
        set interface wan2
        set vlanid 20
        set allowaccess ping
    next
    edit "VLAN_30"
        set description "VLAN for Cell 3 Traffic"
        set vdom "root"
        set mode static
        set ip 172.16.13.6 255.255.255.252
        set type vlan
        set interface wan2
        set vlanid 30
        set allowaccess ping
    next
    edit internal1
        set description "To OT-NET"
        set vdom "root"
        set mode static
        # set ip 10.34.255.254 255.255.0.0
        # HIER IST TEMPORÄR FÜR GUI CONFIG PURPOSES AUCH HTTP/HTTPS AN, BITTE ENTFERNEN
        set allowaccess ping http https
        set type physical
    next
    edit internal2
        set description "To OT-DMZ"
        set vdom "root"
        set mode static
        set ip 192.168.33.254 255.255.255.0
        # HIER IST TEMPORÄR FÜR GUI CONFIG PURPOSES AUCH HTTP/HTTPS AN, BITTE ENTFERNEN
        set allowaccess ping http https
        set type physical
    next
    # TEMPORÄR FÜR TOFT
    edit "VLAN_120"
        set description "MANAGEMENT"
        set vdom "root"
        set mode static
        set ip 10.40.20.254 255.255.255.0
        set type vlan
        set interface internal1
        set vlanid 120
    next
    edit "VLAN_150"
        set description "OTHER AKA QUASI OT-NET"
        set vdom "root"
        set mode static
        set ip 10.34.255.254 255.255.0.0
        set type vlan
        set interface internal1
        set vlanid 150
    next
end

config firewall address
    edit "SIMATIC"
        set subnet 10.79.84.1 255.255.255.255
        set comment "Siemens SIMATIC PLC"
    next
    edit "OpenPLC"
        set subnet 10.79.84.5 255.255.255.255
        set comment "OpenPLC PLC (Raspberry Pi)"
    next
    edit "LOGO!"
        set subnet 10.79.84.9 255.255.255.255
        set comment "Siemens LOGO! PLC"
    next
    edit "SCADA"
        set subnet 10.34.0.50 255.255.255.255
        set comment "SCADA-LTS"
    next
    edit "OT_Workstations"
        # TODO: Hier das Subnetz von der DHCP-Range angeben! DERZEIT TEMPORÄRE LÖSUNG
        set subnet 10.34.0.0 255.255.0.0
        set comment "Workstations for accessing the SCADA"
    next
end
config firewall service category
    edit "Bus"
        set comment "TCP/IP Encapsulated Bus Protocols"
    next
end
config firewall service custom
    edit "MODBUS_TCP"
        set category "Bus"
        set protocol TCP
        set helper disable
        set color 17
        set tcp-portrange 502-502
    next
end

config firewall policy
    edit 1
       set name "SCADA_to_SIMATIC"
       #set srcintf "internal1"
       set srcintf "VLAN_150"
       set dstintf "VLAN_10"
       set srcaddr "SCADA"
       set dstaddr "SIMATIC"
       set action accept
       set schedule "always"
       set service "PING" "MODBUS_TCP"
       set logtraffic all
       set status enable
   next
   edit 2
       set name "SCADA_to_OpenPLC"
       #set srcintf "internal1"
       set srcintf "VLAN_150"
       set dstintf "VLAN_20"
       set srcaddr "SCADA"
       set dstaddr "OpenPLC"
       set action accept
       set schedule "always"
       set service "PING" "MODBUS_TCP"
       set logtraffic all
       set status enable
   next
   edit 3
       set name "SCADA_to_LOGO!"
       #set srcintf "internal1"
       set srcintf "VLAN_150"
       set dstintf "VLAN_30"
       set srcaddr "SCADA"
       set dstaddr "LOGO!"
       set action accept
       set schedule "always"
       set service "PING" "MODBUS_TCP"
       set logtraffic all
       set status enable
   next
end

config router static
    edit 1
        set gateway 172.16.10.2
        set device "wan1"
    next
    edit 2
        set gateway 172.16.11.5
        set device "VLAN_10"
        set dst 10.79.84.0 255.255.255.252
    next
    edit 3
        set gateway 172.16.12.5
        set device "VLAN_20"
        set dst 10.79.84.4 255.255.255.252
    next
    edit 4
        set gateway 172.16.13.5
        set device "VLAN_30"
        set dst 10.79.84.8 255.255.255.252
    next
end

config log setting
    set status enable
    set logmemory enable
    set log-disk-full overwrite
    set severity warning
end

config log syslogd setting
    set status enable
    set server "192.168.31.100"
    set mode udp
    set port 514
    set facility local7
end

# TEMPORÄR FÜR TOFT
config system dns-database
    edit ESXi
        set domain fenrir.local
        set type master
        set view shadow
        set ttl 86400
        set authoritative disable
        config dns-entry
            edit 1
                set hostname esxi1.fenrir.local
                set type A
                set ip 10.40.20.11
                set status enable
            next
            edit 2
                set hostname cluster-switch.fenrir.local
                set type A
                set ip 10.40.20.200
                set status enable
            next
            edit 3
                set hostname nozomi.fenrir.local
                set type A
                set ip 10.40.20.100
                set status enable
            next
        end
    next
end

config system dns-server
    edit VLAN_120
        set mode recursive
    next
end
